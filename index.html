<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="mobile-web-app-capable" content="yes" />
  <title>Getr√§nke-App</title>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap');
    
    html {
      height: 100%;
      height: 100dvh;
      overflow: hidden;
      position: fixed;
      width: 100%;
    }
    
    * {
      box-sizing: border-box;
      -webkit-tap-highlight-color: transparent;
    }
    
    body, button, input, span {
      font-family: 'Poppins', sans-serif;
    }

    body {
      margin: 0;
      padding: 0;
      background: linear-gradient(135deg, #0a0a0a 0%, #1a1a1a 100%);
      color: #fff;
      height: 100vh;
      height: 100dvh;
      display: flex;
      flex-direction: column;
      overflow: hidden;
      position: fixed;
      width: 100%;
    }

    #buttons {
      flex: 1;
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(45%, 1fr));
      grid-auto-rows: 1fr;
      gap: 12px;
      padding: 12px;
      overflow-y: auto;
      overflow-x: hidden;
      -webkit-overflow-scrolling: touch;
    }

    .btn {
      font-size: 24px;
      font-weight: 600;
      letter-spacing: -0.5px;
      border: 1px solid rgba(255, 255, 255, 0.1);
      background: linear-gradient(135deg, #2a2a2a 0%, #1f1f1f 100%);
      border-radius: 18px;
      color: white;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
      opacity: 0;
      animation: fadeIn 0.3s cubic-bezier(0.4, 0, 0.2, 1) forwards;
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.4);
      position: relative;
      overflow: hidden;
    }

    .btn::before {
      content: '';
      position: absolute;
      inset: 0;
      background: linear-gradient(135deg, rgba(255,255,255,0.1) 0%, rgba(255,255,255,0.05) 100%);
      opacity: 0;
      transition: opacity 0.2s;
    }

    .btn:hover::before { opacity: 1; }
    .btn:active { 
      transform: scale(0.96);
      box-shadow: 0 2px 10px rgba(0, 0, 0, 0.3);
    }

    @keyframes fadeIn {
      from { 
        opacity: 0; 
        transform: translateY(10px) scale(0.95);
      }
      to { 
        opacity: 1; 
        transform: translateY(0) scale(1);
      }
    }

    #bottombar {
      height: 80px;
      background: rgba(20, 20, 20, 0.95);
      backdrop-filter: blur(20px);
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 0 12px;
      border-top: 1px solid rgba(255, 255, 255, 0.1);
      box-shadow: 0 -4px 30px rgba(0, 0, 0, 0.3);
    }

    .barBtn {
      background: linear-gradient(135deg, #2a2a2a 0%, #1f1f1f 100%);
      border: 1px solid rgba(255, 255, 255, 0.1);
      padding: 14px 24px;
      font-size: 18px;
      font-weight: 600;
      border-radius: 14px;
      color: white;
      transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
      box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3);
    }

    .barBtn:hover { 
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(0, 0, 0, 0.4);
    }
    .barBtn:active { 
      transform: translateY(0);
      box-shadow: 0 2px 10px rgba(0, 0, 0, 0.3);
    }

    .barBtn.back {
      background: linear-gradient(135deg, #8b1f1f 0%, #6b1515 100%);
      border: 1px solid rgba(255, 255, 255, 0.1);
    }

    .barBtn.back:hover {
      background: linear-gradient(135deg, #9b2f2f 0%, #7b1f1f 100%);
    }

    #numberOverlay {
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.97);
      backdrop-filter: blur(10px);
      display: none;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      padding: 20px;
      z-index: 100;
    }

    #numberText {
      font-size: 22px;
      font-weight: 600;
      margin-bottom: 24px;
      text-align: center;
      color: #fff;
    }

    #numberOverlay input {
      width: 140px;
      padding: 14px;
      font-size: 24px;
      font-weight: 600;
      border-radius: 14px;
      border: 2px solid rgba(255, 255, 255, 0.1);
      text-align: center;
      margin: 6px;
      background: #1a1a1a;
      color: #fff;
      transition: all 0.2s;
    }

    #numberOverlay input:focus {
      outline: none;
      border-color: rgba(255, 255, 255, 0.3);
      box-shadow: 0 0 0 4px rgba(255, 255, 255, 0.05);
    }

    #numberOverlay button {
      margin-top: 16px;
      padding: 14px 36px;
      font-size: 20px;
      font-weight: 600;
      border-radius: 16px;
      border: 1px solid rgba(255, 255, 255, 0.1);
      background: linear-gradient(135deg, #2a2a2a 0%, #1f1f1f 100%);
      color: white;
      cursor: pointer;
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.4);
      transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
    }

    #numberOverlay button:hover {
      background: linear-gradient(135deg, #353535 0%, #2a2a2a 100%);
      transform: translateY(-2px);
      box-shadow: 0 6px 25px rgba(0, 0, 0, 0.5);
    }

    #numberOverlay button:active {
      transform: translateY(0);
    }

    #listPage {
      position: fixed;
      inset: 0;
      background: linear-gradient(135deg, #0a0a0a 0%, #1a1a1a 100%);
      display: none;
      flex-direction: column;
      padding: 16px 16px 0 16px;
      overflow-y: auto;
      z-index: 50;
    }

    #listContent {
      flex: 1;
      overflow-y: auto;
      padding-bottom: 16px;
    }

    #listFooter {
      padding: 16px 0;
      display: flex;
      justify-content: center;
      background: linear-gradient(180deg, transparent 0%, #0a0a0a 20%);
    }

    .listSection {
      margin-bottom: 16px;
      background: linear-gradient(135deg, rgba(30, 30, 30, 0.8) 0%, rgba(20, 20, 20, 0.8) 100%);
      backdrop-filter: blur(10px);
      border-radius: 28px;
      padding: 10px 14px 14px 14px;
      border: 1px solid rgba(255, 255, 255, 0.08);
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.4);
    }

    .listSection:last-of-type {
      margin-bottom: 0;
    }

    .sectionTitle {
      font-size: 20px;
      margin-bottom: 10px;
      font-weight: 700;
      letter-spacing: -0.5px;
      color: #fff;
      padding-bottom: 8px;
      border-bottom: 2px solid rgba(255, 255, 255, 0.15);
    }

    .item {
      padding: 12px 12px 8px 12px;
      margin: 8px 0;
      background: linear-gradient(135deg, rgba(40, 40, 40, 0.6) 0%, rgba(30, 30, 30, 0.6) 100%);
      border-radius: 14px;
      display: flex;
      flex-direction: column;
      gap: 10px;
      border: 1px solid rgba(255, 255, 255, 0.05);
      transition: all 0.2s;
    }

    .item:last-child {
      margin-bottom: 0;
    }

    .itemTop {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      gap: 10px;
    }

    .itemContent {
      flex: 1;
      display: flex;
      flex-direction: column;
      gap: 6px;
      min-width: 0;
    }

    .itemRow {
      display: flex;
      align-items: center;
      gap: 6px;
      flex-wrap: wrap;
    }

    .itemBadge {
      background: rgba(255, 255, 255, 0.12);
      padding: 5px 10px;
      border-radius: 6px;
      font-size: 13px;
      font-weight: 500;
      color: #fff;
      white-space: nowrap;
    }

    .itemQuantity {
      color: rgba(255, 255, 255, 0.75);
      font-size: 13px;
      font-weight: 500;
      margin-top: 2px;
    }

    .delete {
      background: linear-gradient(135deg, #d32f2f 0%, #b71c1c 100%);
      border: none;
      color: white;
      padding: 8px 12px;
      border-radius: 8px;
      font-size: 13px;
      font-weight: 600;
      transition: all 0.2s;
      box-shadow: 0 2px 8px rgba(183, 28, 28, 0.3);
      flex-shrink: 0;
      align-self: flex-start;
    }

    .item:hover {
      background: linear-gradient(135deg, rgba(45, 45, 45, 0.7) 0%, rgba(35, 35, 35, 0.7) 100%);
      border-color: rgba(255, 255, 255, 0.1);
    }

    .delete:hover { 
      transform: scale(1.05);
      box-shadow: 0 4px 12px rgba(183, 28, 28, 0.5);
    }
    .delete:active { 
      transform: scale(0.95);
    }

    #listClose {
      padding: 14px 36px;
      font-size: 20px;
      font-weight: 600;
      border-radius: 16px;
      border: 1px solid rgba(255, 255, 255, 0.1);
      background: linear-gradient(135deg, #2a2a2a 0%, #1f1f1f 100%);
      color: white;
      cursor: pointer;
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.4);
      transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
    }

    #listClose:hover {
      background: linear-gradient(135deg, #353535 0%, #2a2a2a 100%);
      transform: translateY(-2px);
      box-shadow: 0 6px 25px rgba(0, 0, 0, 0.5);
    }

    #listClose:active {
      transform: translateY(0);
    }

    ::-webkit-scrollbar {
      width: 8px;
    }

    ::-webkit-scrollbar-track {
      background: transparent;
    }

    ::-webkit-scrollbar-thumb {
      background: rgba(255, 255, 255, 0.2);
      border-radius: 10px;
    }

    ::-webkit-scrollbar-thumb:hover {
      background: rgba(255, 255, 255, 0.3);
    }
  </style>
</head>
<body>

<div id="buttons"></div>

<div id="bottombar">
  <button class="barBtn back" onclick="goBack()">Zur√ºck</button>
  <button class="barBtn" onclick="toggleList()">üìù Liste</button>
  <button class="barBtn" onclick="logout()" style="background: linear-gradient(135deg, #5b5b5b 0%, #4a4a4a 100%);">@</button>
</div>

<div id="numberOverlay">
  <div id="numberText"></div>
  <input type="number" id="kaestenInput" placeholder="K√§sten" min="0">
  <input type="number" id="flaschenInput" placeholder="Flaschen" min="0">
  <button onclick="confirmQuantities()">Best√§tigen</button>
</div>

<div id="listPage">
  <div id="listContent"></div>
  <div id="listFooter">
    <button id='listClose' onclick='toggleList()'>‚úñ Schlie√üen</button>
  </div>
</div>

<script>
  const kundeSteps = [
    { name: "Type", options: ["Leergut", "Neu"] }
  ];

  const kundeLeergutPreise = ["3,30‚Ç¨", "3,10‚Ç¨", "3,42‚Ç¨", "5,10‚Ç¨", "4,50‚Ç¨", "2,40‚Ç¨", "1,50‚Ç¨", "3,00‚Ç¨"];

  const kundeNeuSteps = [
    { name: "Material", options: ["Glas", "Plastik"] },
    { name: "Typ", options: ["Medium", "Classic", "Still", "Zitrone"] },
    { name: "Marke", options: ["Engelbert", "Stiftsquelle", "Gerolsteiner", "Heiligentaler", "Forstetal"] }
  ];

  const lagerSteps = [
    { name: "Material", options: ["Glas", "Plastik"] },
    { name: "Typ", options: ["Medium", "Classic", "Still", "Zitrone"] },
    { name: "Marke", options: ["Engelbert", "Stiftsquelle", "Gerolsteiner", "Heiligentaler", "Forstetal"] }
  ];

  let mode = null;
  let kundeSubMode = null;
  let currentStep = 0;
  let currentItem = {};
  let kundeList = [];
  let lagerList = [];
  let currentIndex = null;
  let currentUser = null;
  let selectedUsername = null;

  const users = {
    "Kasse": { password: "1234", role: "kasse" },
    "Arbeiter": { password: "1234", role: "arbeiter" }
  };

  // Storage-Funktionen mit window.storage
  async function loadFromStorage() {
    try {
      const kundeData = await window.storage.get('kundeList', true);
      const lagerData = await window.storage.get('lagerList', true);
      
      if (kundeData) kundeList = JSON.parse(kundeData.value);
      if (lagerData) lagerList = JSON.parse(lagerData.value);
    } catch (e) {
      console.log('Keine gespeicherten Daten gefunden');
    }
  }

  async function saveToStorage() {
    try {
      await window.storage.set('kundeList', JSON.stringify(kundeList), true);
      await window.storage.set('lagerList', JSON.stringify(lagerList), true);
    } catch (e) {
      console.error('Fehler beim Speichern:', e);
    }
  }

  async function init() {
    await loadFromStorage();
    if (!currentUser) {
      showLogin();
      return;
    }
    mode = null;
    kundeSubMode = null;
    currentStep = 0;
    currentItem = {};
    renderModeSelection();
  }

  function showLogin() {
    document.getElementById("buttons").innerHTML = `
      <div style="grid-column: 1 / -1; display: flex; flex-direction: column; align-items: center; justify-content: center; gap: 20px; padding: 20px;">
        <h1 style="font-size: 32px; font-weight: 700; margin-bottom: 20px;">Anmeldung</h1>
        <div style="width: 100%; max-width: 320px; display: flex; flex-direction: column; gap: 16px;">
          <div style="display: flex; flex-direction: column; gap: 12px;">
            <button class="user-select-btn" data-user="Kasse" onclick="selectUser('Kasse')" style="padding: 20px; font-size: 18px; font-weight: 600; border-radius: 14px; border: 2px solid rgba(255,255,255,0.1); background: linear-gradient(135deg, #2a2a2a 0%, #1f1f1f 100%); color: #fff; cursor: pointer; transition: all 0.2s; text-align: center;">
              üë§ Kasse
            </button>
            <button class="user-select-btn" data-user="Arbeiter" onclick="selectUser('Arbeiter')" style="padding: 20px; font-size: 18px; font-weight: 600; border-radius: 14px; border: 2px solid rgba(255,255,255,0.1); background: linear-gradient(135deg, #2a2a2a 0%, #1f1f1f 100%); color: #fff; cursor: pointer; transition: all 0.2s; text-align: center;">
              üë∑ Arbeiter
            </button>
          </div>
          <input type="password" id="password" placeholder="Passwort eingeben" style="width: 100%; padding: 18px; font-size: 18px; font-weight: 500; border-radius: 14px; border: 2px solid rgba(255,255,255,0.1); background: #1a1a1a; color: #fff; text-align: center;" disabled>
          <button id="loginBtn" onclick="login()" style="padding: 18px; font-size: 20px; font-weight: 600; border-radius: 14px; border: none; background: linear-gradient(135deg, #4CAF50 0%, #45a049 100%); color: white; cursor: pointer; box-shadow: 0 4px 20px rgba(76,175,80,0.4); opacity: 0.5; transition: all 0.2s;" disabled>
            Anmelden
          </button>
          <div id="loginError" style="color: #ff5252; font-size: 16px; font-weight: 500; text-align: center; display: none; padding: 12px; background: rgba(255,82,82,0.1); border-radius: 10px;">Falsche Anmeldedaten!</div>
        </div>
      </div>
    `;
    document.getElementById("bottombar").style.display = "none";
  }

  function selectUser(username) {
    selectedUsername = username;
    const buttons = document.querySelectorAll('.user-select-btn');
    buttons.forEach(btn => {
      if (btn.dataset.user === username) {
        btn.style.border = '2px solid #4CAF50';
        btn.style.background = 'linear-gradient(135deg, #2a4a2a 0%, #1f3f1f 100%)';
      } else {
        btn.style.border = '2px solid rgba(255,255,255,0.1)';
        btn.style.background = 'linear-gradient(135deg, #2a2a2a 0%, #1f1f1f 100%)';
      }
    });
    
    const passwordInput = document.getElementById('password');
    const loginBtn = document.getElementById('loginBtn');
    passwordInput.disabled = false;
    passwordInput.focus();
    loginBtn.disabled = false;
    loginBtn.style.opacity = '1';
  }

  function login() {
    const username = selectedUsername;
    const password = document.getElementById("password").value;
    const error = document.getElementById("loginError");

    if (!username) {
      error.textContent = "Bitte w√§hle einen Benutzer!";
      error.style.display = "block";
      return;
    }

    if (users[username] && users[username].password === password) {
      currentUser = { username, role: users[username].role };
      error.style.display = "none";
      document.getElementById("bottombar").style.display = "flex";
      
      if (currentUser.role === "kasse") {
        showKasseView();
      } else {
        init();
      }
    } else {
      error.textContent = "Falsches Passwort!";
      error.style.display = "block";
    }
  }

  function logout() {
    currentUser = null;
    selectedUsername = null;
    init();
  }

  function renderModeSelection() {
    if (currentUser.role === "kasse") {
      showKasseView();
      return;
    }
    document.getElementById("buttons").innerHTML = `
      <button class='btn' onclick='selectMode("kunde")'>Kunde</button>
      <button class='btn' onclick='selectMode("lager")'>Lager</button>
    `;
  }

  async function showKasseView() {
    await loadFromStorage();
    document.getElementById("buttons").innerHTML = `
      <div style="grid-column: 1 / -1; display: flex; flex-direction: column; height: 100%; overflow-y: auto; padding: 20px;">
        <h1 style="font-size: 28px; font-weight: 700; margin-bottom: 20px; text-align: center;">Kunden-Bestellungen</h1>
        <div id="kasseContent"></div>
      </div>
    `;
    renderKasseList();
  }

  function renderKasseList() {
    const container = document.getElementById("kasseContent");
    if (!container) return;
    
    let html = '';

    if (kundeList.length === 0) {
      html = '<div style="text-align: center; padding: 40px; color: rgba(255,255,255,0.5); font-size: 18px;">Keine Bestellungen vorhanden</div>';
    } else {
      const kundeLeergut = kundeList.filter(i => i.Type === 'Leergut');
      const kundeNeu = kundeList.filter(i => i.Type === 'Neu');
      
      if (kundeLeergut.length) {
        html += `<div class='listSection'><div class='sectionTitle' style='font-size: 20px;'>Leergut</div>`;
        kundeLeergut.forEach((item, idx) => {
          const globalIndex = kundeList.indexOf(item);
          html += `
            <div class='item'>
              <div class='itemTop'>
                <div class='itemContent'>
                  <div class='itemRow'>
                    <span class='itemBadge'>${item.Preis}</span>
                  </div>
                  <span class='itemQuantity'>${item.kaesten} K√§sten + ${item.extraflaschen} Flaschen</span>
                </div>
                <button class='delete' onclick='deleteKundeItemKasse(${globalIndex})'>L√∂schen</button>
              </div>
            </div>`;
        });
        html += `</div>`;
      }
      
      if (kundeNeu.length) {
        html += `<div class='listSection' style='margin-top: 16px;'><div class='sectionTitle' style='font-size: 20px;'>Neu</div>`;
        kundeNeu.forEach((item, idx) => {
          const globalIndex = kundeList.indexOf(item);
          html += `
            <div class='item'>
              <div class='itemTop'>
                <div class='itemContent'>
                  <div class='itemRow'>
                    <span class='itemBadge'>${item.Material}</span>
                    <span class='itemBadge'>${item.Typ}</span>
                    <span class='itemBadge'>${item.Marke}</span>
                  </div>
                  <span class='itemQuantity'>${item.kaesten} K√§sten + ${item.extraflaschen} Flaschen</span>
                </div>
                <button class='delete' onclick='deleteKundeItemKasse(${globalIndex})'>L√∂schen</button>
              </div>
            </div>`;
        });
        html += `</div>`;
      }
      
      html += `<div style="margin-top: 24px; text-align: center;">
        <button onclick="clearAllKunde()" style="padding: 14px 32px; font-size: 18px; font-weight: 600; border-radius: 14px; border: none; background: linear-gradient(135deg, #d32f2f 0%, #b71c1c 100%); color: white; cursor: pointer; box-shadow: 0 4px 20px rgba(183,28,28,0.4);">Alle l√∂schen</button>
      </div>`;
    }

    container.innerHTML = html;
  }

  async function deleteKundeItemKasse(i) {
    kundeList.splice(i, 1);
    sortKundeList();
    await saveToStorage();
    renderKasseList();
  }

  async function clearAllKunde() {
    if (confirm('Alle Kunden-Bestellungen l√∂schen?')) {
      kundeList = [];
      await saveToStorage();
      if (currentUser.role === "kasse") {
        renderKasseList();
      } else {
        renderList();
      }
    }
  }

  function selectMode(m) {
    mode = m;
    currentStep = 0;
    currentItem = { mode: mode };
    
    if (mode === "kunde") {
      renderKundeTypeSelection();
    } else {
      renderLagerStep();
    }
  }

  function renderKundeTypeSelection() {
    document.getElementById("buttons").innerHTML = kundeSteps[0].options.map(opt => `
      <button class='btn' onclick='selectKundeType("${opt}")'>${opt}</button>`).join("");
  }

  function selectKundeType(type) {
    kundeSubMode = type.toLowerCase();
    currentItem.Type = type;
    
    if (kundeSubMode === "leergut") {
      renderKundeLeergutPreise();
    } else {
      currentStep = 0;
      renderKundeNeuStep();
    }
  }

  function renderKundeLeergutPreise() {
    document.getElementById("buttons").innerHTML = kundeLeergutPreise.map(preis => `
      <button class='btn' onclick='selectLeergutPreis("${preis}")'>${preis}</button>`).join("");
  }

  async function selectLeergutPreis(preis) {
    currentItem.Preis = preis;
    currentItem.kaesten = 0;
    currentItem.extraflaschen = 0;
    kundeList.push({ ...currentItem });
    currentIndex = kundeList.length - 1;
    sortKundeList();
    await saveToStorage();
    showNumberOverlay("kunde");
  }

  function renderKundeNeuStep() {
    const step = kundeNeuSteps[currentStep];
    document.getElementById("buttons").innerHTML = step.options.map(opt => `
      <button class='btn' onclick='selectKundeNeuOption("${opt}")'>${opt}</button>`).join("");
  }

  async function selectKundeNeuOption(opt) {
    const key = kundeNeuSteps[currentStep].name;
    currentItem[key] = opt;
    currentStep++;

    if (currentStep >= kundeNeuSteps.length) {
      currentItem.kaesten = 0;
      currentItem.extraflaschen = 0;
      kundeList.push({ ...currentItem });
      currentIndex = kundeList.length - 1;
      currentStep = 0;
      sortKundeList();
      await saveToStorage();
      showNumberOverlay("kunde");
    } else {
      renderKundeNeuStep();
    }
  }

  function renderLagerStep() {
    const step = lagerSteps[currentStep];
    document.getElementById("buttons").innerHTML = step.options.map(opt => `
      <button class='btn' onclick='selectLagerOption("${opt}")'>${opt}</button>`).join("");
  }

  async function selectLagerOption(opt) {
    const key = lagerSteps[currentStep].name;
    currentItem[key] = opt;
    currentStep++;

    if (currentStep >= lagerSteps.length) {
      currentItem.kaesten = 0;
      currentItem.extraflaschen = 0;
      lagerList.push({ ...currentItem });
      currentIndex = lagerList.length - 1;
      currentStep = 0;
      sortLagerList();
      await saveToStorage();
      showNumberOverlay("lager");
    } else {
      renderLagerStep();
    }
  }

  function showNumberOverlay(listType) {
    const overlay = document.getElementById('numberOverlay');
    const kaestenInput = document.getElementById('kaestenInput');
    const flaschenInput = document.getElementById('flaschenInput');

    const list = listType === "kunde" ? kundeList : lagerList;
    const item = list[currentIndex];
    
    let text = '';
    if (listType === "kunde" && item.Type === "Leergut") {
      text = `Anzahl f√ºr ${item.Preis}`;
    } else if (listType === "kunde") {
      text = `Anzahl f√ºr ${item.Marke}`;
    } else {
      text = `Anzahl f√ºr ${item.Marke}`;
    }
    
    document.getElementById('numberText').textContent = text;
    kaestenInput.value = '';
    flaschenInput.value = '';

    if (listType === "lager") {
      flaschenInput.style.display = 'none';
    } else {
      flaschenInput.style.display = 'block';
    }

    overlay.style.display = 'flex';
    kaestenInput.focus();

    function handleEnter(e) {
      if(e.key === 'Enter') confirmQuantities();
    }
    kaestenInput.removeEventListener('keypress', handleEnter);
    flaschenInput.removeEventListener('keypress', handleEnter);
    kaestenInput.addEventListener('keypress', handleEnter);
    flaschenInput.addEventListener('keypress', handleEnter);
  }

  async function confirmQuantities() {
    const kaesten = parseInt(document.getElementById('kaestenInput').value) || 0;
    const flaschen = mode === "lager" ? 0 : (parseInt(document.getElementById('flaschenInput').value) || 0);
    
    const list = mode === "kunde" ? kundeList : lagerList;
    list[currentIndex].kaesten = kaesten;
    list[currentIndex].extraflaschen = flaschen;
    await saveToStorage();
    
    document.getElementById('numberOverlay').style.display = 'none';
    currentItem = { mode: mode };
    
    if (mode === "kunde") {
      if (kundeSubMode === "leergut") {
        renderKundeLeergutPreise();
      } else {
        currentStep = 0;
        renderKundeTypeSelection();
      }
    } else {
      renderLagerStep();
    }
  }

  function goBack() {
    if (!currentUser) return;
    if (currentUser.role === "kasse") {
      return;
    }
    if (mode === null) {
      return;
    }
    
    if (mode === "kunde") {
      if (kundeSubMode === "neu" && currentStep > 0) {
        currentStep--;
        renderKundeNeuStep();
      } else if (kundeSubMode === "leergut") {
        kundeSubMode = null;
        currentItem = { mode: "kunde" };
        renderKundeTypeSelection();
      } else if (kundeSubMode === "neu") {
        kundeSubMode = null;
        currentItem = { mode: "kunde" };
        renderKundeTypeSelection();
      } else {
        mode = null;
        currentItem = {};
        init();
      }
    } else if (mode === "lager") {
      if (currentStep > 0) {
        currentStep--;
        renderLagerStep();
      } else {
        mode = null;
        currentItem = {};
        init();
      }
    }
  }

  function sortKundeList() {
    kundeList.sort((a, b) => a.Type === "Leergut" ? -1 : 1);
  }

  function sortLagerList() {
    // Keine spezielle Sortierung f√ºr Lager
  }

  async function renderList() {
    await loadFromStorage();
    const content = document.getElementById("listContent");
    let html = '';

    if (kundeList.length) {
      html += `<div class='listSection'><div class='sectionTitle' style='font-size: 24px; margin-bottom: 12px;'>KUNDE</div>`;
      
      const kundeLeergut = kundeList.filter(i => i.Type === 'Leergut');
      const kundeNeu = kundeList.filter(i => i.Type === 'Neu');
      
      if (kundeLeergut.length) {
        html += `<div style='margin-bottom: 12px;'><div class='sectionTitle' style='font-size: 18px;'>Leergut</div>`;
        kundeLeergut.forEach((item, idx) => {
          const globalIndex = kundeList.indexOf(item);
          html += `
            <div class='item'>
              <div class='itemTop'>
                <div class='itemContent'>
                  <div class='itemRow'>
                    <span class='itemBadge'>${item.Preis}</span>
                  </div>
                  <span class='itemQuantity'>${item.kaesten} K√§sten + ${item.extraflaschen} Flaschen</span>
                </div>
                <button class='delete' onclick='deleteKundeItem(${globalIndex})'>L√∂schen</button>
              </div>
            </div>`;
        });
        html += `</div>`;
      }
      
      if (kundeNeu.length) {
        html += `<div><div class='sectionTitle' style='font-size: 18px;'>Neu</div>`;
        kundeNeu.forEach((item, idx) => {
          const globalIndex = kundeList.indexOf(item);
          html += `
            <div class='item'>
              <div class='itemTop'>
                <div class='itemContent'>
                  <div class='itemRow'>
                    <span class='itemBadge'>${item.Material}</span>
                    <span class='itemBadge'>${item.Typ}</span>
                    <span class='itemBadge'>${item.Marke}</span>
                  </div>
                  <span class='itemQuantity'>${item.kaesten} K√§sten + ${item.extraflaschen} Flaschen</span>
                </div>
                <button class='delete' onclick='deleteKundeItem(${globalIndex})'>L√∂schen</button>
              </div>
            </div>`;
        });
        html += `</div>`;
      }
      
      html += `<div style="margin-top: 16px; text-align: center;">
        <button onclick="clearAllKundeWorker()" style="padding: 12px 28px; font-size: 16px; font-weight: 600; border-radius: 12px; border: none; background: linear-gradient(135deg, #d32f2f 0%, #b71c1c 100%); color: white; cursor: pointer; box-shadow: 0 4px 15px rgba(183,28,28,0.4);">Alle Kunden-Bestellungen l√∂schen</button>
      </div></div>`;
    }

    if (lagerList.length) {
      html += `<div class='listSection'><div class='sectionTitle' style='font-size: 24px; margin-bottom: 12px;'>LAGER</div>`;
      lagerList.forEach((item, idx) => {
        html += `
          <div class='item'>
            <div class='itemTop'>
              <div class='itemContent'>
                <div class='itemRow'>
                  <span class='itemBadge'>${item.Material}</span>
                  <span class='itemBadge'>${item.Typ}</span>
                  <span class='itemBadge'>${item.Marke}</span>
                </div>
                <span class='itemQuantity'>${item.kaesten} K√§sten</span>
              </div>
              <button class='delete' onclick='deleteLagerItem(${idx})'>L√∂schen</button>
            </div>
          </div>`;
      });
      html += `<div style="margin-top: 16px; text-align: center;">
        <button onclick="clearAllLager()" style="padding: 12px 28px; font-size: 16px; font-weight: 600; border-radius: 12px; border: none; background: linear-gradient(135deg, #d32f2f 0%, #b71c1c 100%); color: white; cursor: pointer; box-shadow: 0 4px 15px rgba(183,28,28,0.4);">Alle Lager-Eintr√§ge l√∂schen</button>
      </div></div>`;
    }

    content.innerHTML = html;
  }

  async function clearAllKundeWorker() {
    if (confirm('Alle Kunden-Bestellungen l√∂schen?')) {
      kundeList = [];
      await saveToStorage();
      renderList();
    }
  }

  async function clearAllLager() {
    if (confirm('Alle Lager-Eintr√§ge l√∂schen?')) {
      lagerList = [];
      await saveToStorage();
      renderList();
    }
  }

  async function deleteKundeItem(i) {
    kundeList.splice(i, 1);
    sortKundeList();
    await saveToStorage();
    renderList();
  }

  async function deleteLagerItem(i) {
    lagerList.splice(i, 1);
    await saveToStorage();
    renderList();
  }

  function toggleList() {
    if (!currentUser) return;
    if (currentUser.role === "kasse") return;
    
    const page = document.getElementById("listPage");
    if (page.style.display === "flex") {
      page.style.display = "none";
    } else {
      page.style.display = "flex";
      renderList();
    }
  }

  init();
</script>

</body>
</html>
